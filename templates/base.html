<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}å…¬å¸å†…ç½‘é—¨æˆ·{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon å®Œæ•´è®¾ç½® -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- å¤‡ç”¨PNGæ ¼å¼ -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
    <!-- Appleè®¾å¤‡ -->
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/favicon.png') }}">
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="global-header">
        <div class="header-container">
            <a href="{{ url_for('index') }}" class="logo-link">
                <div class="logo-container">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="æ²³å—å“è¿œæ£€æµ‹æœ‰é™å…¬å¸" class="logo-img">
                    <div class="logo-text">
                        <span class="company-name">æ²³å—å“è¿œæ£€æµ‹æœ‰é™å…¬å¸</span>
                        <span class="divider">|</span>
                        <span class="portal-name">ååŒåŠå…¬å¹³å°</span>
                    </div>
                </div>
            </a>
            <div class="user-info">
                <div class="user-details">
                    <i class="fas fa-user-circle user-icon"></i>
                    <span class="username">{{ current_user.username }}</span>
                    <span class="user-department">{{ current_user.department }}</span>
                </div>
                <div class="user-notifications">
                    <a href="{{ url_for('messages_list') }}" class="messages-link" title="æ¶ˆæ¯ä¸­å¿ƒ">
                        <i class="fas fa-bell"></i>
                        {% if current_user.received_messages %}
                            {% set unread_count = current_user.received_messages|selectattr('is_read', 'equalto', False)|list|length %}
                            {% if unread_count > 0 %}
                            <span class="notification-badge">{{ unread_count }}</span>
                            {% endif %}
                        {% endif %}
                    </a>
                    <a href="{{ url_for('logout') }}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        é€€å‡ºç™»å½•
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    {% block breadcrumb %}
        {% include 'breadcrumb.html' %}
    {% endblock %}

    <!-- é—ªå­˜æ¶ˆæ¯ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- åœ¨ç”¨æˆ·æœªç™»å½•æ—¶æ˜¾ç¤ºæ³¨å†Œé“¾æ¥ -->
    {% if not current_user.is_authenticated %}
    <div style="text-align: center; margin: 1rem 0;">
        <p style="color: #7f8c8d;">
            æ–°ç”¨æˆ·ï¼Ÿ<a href="{{ url_for('register') }}" style="color: #3498db; text-decoration: none; font-weight: 500;">ç«‹å³æ³¨å†Œ</a>
        </p>
    </div>
    {% endif %}
    
    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- å¿«é€Ÿè¿”å›é¦–é¡µæŒ‰é’® -->
    <div class="quick-home">
        <a href="{{ url_for('index') }}" class="home-btn" title="è¿”å›é¦–é¡µ">ğŸ </a>
    </div>

    <!-- é—ªå­˜æ¶ˆæ¯è‡ªåŠ¨éšè—è„šæœ¬ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è‡ªåŠ¨éšè—é—ªå­˜æ¶ˆæ¯
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function(message) {
                // 2ç§’åè‡ªåŠ¨éšè—
                setTimeout(function() {
                    message.style.opacity = '0';
                    setTimeout(function() {
                        message.style.display = 'none';
                    }, 500);
                }, 2000); // æ”¹ä¸º2000æ¯«ç§’ï¼ˆ2ç§’ï¼‰
            });
        });

        // å®šæœŸæ£€æŸ¥æ–°æ¶ˆæ¯
        function checkNewMessages() {
            // æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨
            try {
                fetch('{{ url_for("unread_messages_count") }}')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const messagesLink = document.querySelector('.messages-link');
                        const badge = document.querySelector('.notification-badge');
                        
                        if (data.count > 0) {
                            // æ·»åŠ é—ªçƒç±»å
                            messagesLink.classList.add('has-unread');
                            
                            if (badge) {
                                badge.textContent = data.count;
                            } else {
                                // åˆ›å»ºæ–°çš„å¾½ç« 
                                if (messagesLink) {
                                    const newBadge = document.createElement('span');
                                    newBadge.className = 'notification-badge';
                                    newBadge.textContent = data.count;
                                    messagesLink.appendChild(newBadge);
                                }
                            }
                        } else {
                            // ç§»é™¤é—ªçƒç±»å
                            messagesLink.classList.remove('has-unread');
                            
                            // ç§»é™¤å¾½ç« 
                            if (badge) {
                                badge.remove();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking messages:', error);
                        // ç¦ç”¨æ¶ˆæ¯æ£€æŸ¥åŠŸèƒ½
                        clearInterval(messageCheckInterval);
                    });
            } catch (error) {
                console.error('Messages route not available:', error);
                // ç¦ç”¨æ¶ˆæ¯æ£€æŸ¥åŠŸèƒ½
                clearInterval(messageCheckInterval);
            }
        }

        // åªæœ‰åœ¨æœ‰æ¶ˆæ¯æƒé™æ—¶æ‰å¯åŠ¨æ¶ˆæ¯æ£€æŸ¥
        let messageCheckInterval;
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¶ˆæ¯æƒé™
            const messagesLink = document.querySelector('.messages-link');
            if (messagesLink) {
                // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯
                messageCheckInterval = setInterval(checkNewMessages, 60000);
                // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¸€æ¬¡
                checkNewMessages();
            }
        });
    </script>
</body>
</html>